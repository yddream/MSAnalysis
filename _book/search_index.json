[
["index.html", "基于非靶向代谢组学的化学成分差异性分析 寄言", " 基于非靶向代谢组学的化学成分差异性分析 Yandong Yin 2019-09-02 寄言 借此为代谢组学贡献绵薄之力 "],
["Intro.html", "第 1 章 简介", " 第 1 章 简介 液相色谱-质谱联用技术（LC-MS）在代谢组学中有着非常广泛的应用，代谢组学借助于LC-MS，可以广泛的筛查样品中存在的代谢物（小分子化合物）及其含量，具有高通量、高灵敏度、动态范围广等特点，可以实现优质的代谢组学分析。根据实验目的，一般我们可以采用靶向代谢组学方法进行特定目标代谢物的高准确度定量分析，如MRM/SRM/PRM等技术，也可以采用非靶向代谢组学筛查样品中包含的代谢物及其差异，从而实现广谱的代谢物筛查，根据质谱中数据采集方式的不同，分为数据依赖型采集（DDA）和数据非依赖型采集（DIA）两类(Figure 1.1)。 图 1.1: DDA and DIA MS techniques(Wang, Yin, and Zhu 2019) 其中，DDA技术根据一级质谱扫描时扫描带的离子的强度信息，选择强度较高的部分离子分多次进行碎裂，每次得到于所选择单个目标离子对应的二级谱图，从而实现借助于二级谱图的代谢物鉴定。而DIA技术则是每次选择全部（MSE/AIF）或者部分（SWATH）母离子进行碎裂，理论上可以得到所有母离子的二级信息，然而从数据采集和记录本身无法直接获取每个母离子对应的二级谱图，因而数据分析较为复杂。综合而言，DDA技术作为传统的非靶向LC-MS/MS技术，虽然受限于采集到的二级谱图覆盖范围（一般在30%-60%），但受益于其数据分析的便利性，在代谢组学中有着广泛的应用，而DIA技术，虽然理论上可以获取所有母离子的二级谱图（实际覆盖范围在90%左右），但数据分析较为复杂，数据分析软件仍然有一定的局限性，因而在代谢组学中应用依然较少。 在此，我们主要借助于R和xcms探讨DDA技术的数据分析原理和代谢物鉴定的方法，并介绍常用软件和代谢物鉴定数据库，以及代谢物差异性分析，如有任何错漏或者疑问，欢迎联系本人（ydrick@gmail.com） 参考文献 "],
["basis.html", "第 2 章 R语言及环境配置 2.1 R语言环境安装 2.2 质谱数据分析相关R包安装 2.3 数据准备", " 第 2 章 R语言及环境配置 在此，我们主要基于R语言，并利用XCMS等关于代谢组学数据处理R包进行示例说明，以此来 介绍非靶向代谢组学中LC-MS数据特点和数据处理方法，因而首先介绍环境配置。 2.1 R语言环境安装 2.1.1 R语言安装 R语言可于官方网站下载系统需要的版本，一般选择最新 稳定版本。 Windows和MacOS系统请直接下载安装文件。 Linux系统可以使用系统的软件管理程序自动安装或者下载系统对应的二进制文件进行安装 （参见官方介绍，也可以通过下载源码包， 自行编译安装。 Linux通过系统软件管理程序安装代码如下（如果需要安装最新版可能需要安装新的软件 源，具体请搜索查找，在此不再列出）： # Ubuntu sudo apt-get install r-base # CentOS/Fedora/Redhat # (for CentOS/Redhat to add EPEL repositories) sudo yum install epel-release sudo yum install R 2.1.2 Rstudio安装 Rstudio是目前市面上最常用的R IDE，利用Rstudio可以方便的进行R包开发和数据分析， 因而推荐使用Rstudio作为主要IDE， Rstudio可以从官方网站选择 系统对应的版本进行下载，且有免费版本使用，一般免费版本已经足够支持基本的开发和 数据分析了 如果习惯使用VIM、Emacs或者Sublime Text，亦可以找到R相关的插件，以便进行开发和 调试，在此不再赘述。 2.1.3 Rstudio中设置R包安装源 用Rstudio进行R包安装时，默认会使用Rstudio源(https://cran.rstudio.com/)进行安装， 在部分地区和网络下载速度会比较慢，因而可以选择最近的CRAN源进行安装。 选择Tools - Global Options, 在打开的对话框中找到Packages，点击Change进行选择 （Figure 2.1) 图 2.1: Change CRAN source in Rstudio 2.1.4 Linux/MacOS中安装R缺失库文件 R中有许多R包是调用C/C++开发的，以实现复杂步骤的快速运算，提高运行效率，对这类包 或者部分其他包，在linux或MacOS中进行安装时，会提示无法找到某个lib，这种情况是系 统中缺乏对应依赖的库文件缺失造成的，因而需要安装对应的库文件，然后再安装该R包即可。 具体对于每个提示的缺失的lib，可以搜索对应的Error提示信息和系统信息（如Ubuntu）进行 搜索，即可找到缺失的库文件应该通过安装哪个lib，在此建议使用Google进行搜索，如果 使用百度，请在搜索时使用“R语言”而非“R”。 2.2 质谱数据分析相关R包安装 2.2.1 安装Bioconductor Bioconductor提供了R语言的生物信息软件包，主要用于 生物数据的注释、分析、统计、以及可视化等，最新版本的安装可以参考官方说明 if (!requireNamespace(&quot;BiocManager&quot;, quietly = TRUE)) install.packages(&quot;BiocManager&quot;) BiocManager::install() 新版本的BiocManager包中install方法可以安装Bioconductor中的R包，亦可以安装CRAN中的 R包，因而可以统一使用该方法进行R包安装。 如果是旧版本的R，或者安装旧版本的Biocunductor，请按照一下操作 source(&quot;https://bioconductor.org/biocLite.R&quot;) biocLite(&quot;BiocInstaller&quot;) BiocInstaller::biocLite() 2.2.2 安装XCMS及CAMERA包 library(BiocManager) install(c(&#39;xcms&#39;, &#39;CAMERA&#39;)) 2.3 数据准备 在此，进行质谱数据处理的样例数据，放在GitHub的yddream/MSAnalysis Repository的data文件夹里，可以克隆本Repository，直接运行Rmd文件，或者单独下载进行分析。 "],
["chapDDA.html", "第 3 章 DDA-MS技术概要 3.1 DDA技术介绍", " 第 3 章 DDA-MS技术概要 3.1 DDA技术介绍 "],
["chapPD.html", "第 4 章 基于XCMS的峰检测 4.1 LC-MS中峰检测简介 4.2 原始数据转换 4.3 利用XCMS进行峰检测 4.4 利用CAMERA进行峰注释", " 第 4 章 基于XCMS的峰检测 4.1 LC-MS中峰检测简介 在LC-MS中，每一个色谱峰（peak）代表一个代谢物，峰检测(peak detection或peak spotting) 主要目的是检测样品中存在的代谢物，并将多个样品中属于同一个代谢物的色谱峰归类到一起 （称之为峰分组（peak grouping），分组之后的代表多个样品中同一个代谢物峰组称之为一个 feature）。 目前，最常用的峰检测算法是centWave，该算法灵敏度高，可以自动对峰宽在指定范围内利用 小波分析进行判断，从而判定峰的位置和起止点，但该方法在峰的起止点的判定上由于其算法的 局限性，并不能做到非常准确的判断。 峰分组是在单个样品峰检测的基础上，考虑保留时间（RT）漂移等因素，对属于同一个代谢物 的峰进行分组，在峰分组之前需要峰对齐（peak alignment），在xcms中最常用的峰对齐方法 是Obi-Warp，该方法利用采集到的样品数据中的mz，intensity和RT信息进行全局三维对齐， 对齐之后的RT用于峰分组。一般xcms中常用峰密度分布（group.density）方法进行分组。 在LC-MS的峰检测过程中，但样品的峰检测、跨样品的RT校正（峰对齐）和分组是非常重要且 必不可少的过程，缺少任何一步，都会对数据处理质量造成影响，而在某些特定条件下， Obi-Warp方法会失效，因而在数据处理时要注意看xcms反馈的提示信息，并绘制RT漂移的曲线 方便检查数据是否进行了正确的RT校正。 4.2 原始数据转换 MS采集的数据，不同的仪器厂商有不同的数据记录方式，而利用XCMS等数据处理软件进行处理 之前，需要将原始数据转换为通用的软件支持的格式，xcms支持xml、mzData、mzXML、mzML、 netCDF等数据格式，因而在利用xcms进行数据处理之前，需要对于质谱采集的原始数据进行 格式转换，一般可使用ProteoWizard等,具体可以参考GNPS的文档介绍， 在此不再赘述。目前ProteoWizard数据转换支持情况可参见Figure 4.1(GNPS 2019) 图 4.1: Converting data to MZML/MZXML using ProteoWizard(Wang, Yin, and Zhu 2019) 4.3 利用XCMS进行峰检测 xcms峰检测有两种方法，一种是在xcms3中新近出现的findChromPeaks方法，该方法有很多 新的功能和特性，并方便借用xcms内部的绘图方法，但目前其输出数据格式与其他的常用软件 （如CAMERA）兼容性问题；另一种是传统的xcmsSet方法，由于历史积累和相关软件更新，该 方法目前使用仍较为广泛。以下分别介绍xcms中峰检测的findChromPeaks和xcmsSet方法 4.3.1 xcms3中峰检测的新方法 4.3.1.1 数据导入 require(xcms) ## Get the full path to the data files(mzxml) files &lt;- list.files(&#39;Data&#39;, pattern = &#39;(?i)mzxml$&#39;,full.names = TRUE, recursive = TRUE) ## Create a phenodata data.frame pd &lt;- data.frame(sample_name = sub(basename(files), pattern = &quot;.mzXML&quot;, replacement = &quot;&quot;, fixed = TRUE), sample_group = c(rep(&quot;grp1&quot;, 2), rep(&quot;grp2&quot;, 1)), stringsAsFactors = FALSE) rawData &lt;- readMSData(files = files, pdata = new(&quot;NAnnotatedDataFrame&quot;, pd), mode = &quot;onDisk&quot;) pd ## sample_name sample_group ## 1 DDAdata1 grp1 ## 2 DDAdata2 grp1 ## 3 DDAdata3 grp2 注：readMSData是MSnbase包中读取质谱数据的方法，返回结果为一个属于‘OnDiskMSnExp’ 类的对象。 4.3.1.2 利用centWave算法进行峰检测 # xcms 3 new methods cwp &lt;- CentWaveParam(peakwidth = c(5, 50), noise = 1000, snthresh = 10) xdata &lt;- findChromPeaks(rawData, param = cwp) head(xdata@msFeatureData$chromPeaks) ## mz mzmin mzmax rt rtmin rtmax into intb ## CP0001 702.2 702.2 702.2 45.65 43.14 48.05 8450 8446 ## CP0002 554.2 554.2 554.2 46.84 38.01 49.90 10025 10020 ## CP0003 628.2 628.2 628.2 46.24 43.96 52.94 16639 16634 ## CP0004 629.2 629.2 629.2 46.24 43.14 49.30 8768 8763 ## CP0005 355.1 355.1 355.1 46.84 41.47 53.53 5427 5334 ## CP0006 372.1 372.1 372.1 46.84 41.22 54.15 7815 7351 ## maxo sn sample ## CP0001 5619 5618 1 ## CP0002 6767 2592 1 ## CP0003 10101 1630 1 ## CP0004 5320 1034 1 ## CP0005 3013 80 1 ## CP0006 4097 85 1 4.3.1.3 峰对齐及分组(peak alignment &amp; grouping) 同一代谢物在不同样品的流出时间会略有差异，因而对于峰检测的结果需要进行对齐(alignment)并将不同样品中的统一代谢物分到各自可以表征该代谢物的峰组(peak group)中(代谢组学中一般成为feature)，从而进一步比较不同样品间统一代谢物的含量。通常我们可以使用’obiwarp’算法进行peak alignment，然后利用’density’算法进行peak grouping. ## Correspondence: group peaks across samples. pdp &lt;- PeakDensityParam(sampleGroups = xdata$sample_group, minFraction = 1) xdata &lt;- groupChromPeaks(xdata, param = pdp) ## Now the retention time correction. pgp &lt;- PeakGroupsParam(minFraction = 1) ## Get the peak groups that would be used for alignment. # (grouping with &#39;peakgroup&#39; method) xdata &lt;- adjustRtime(xdata, param = pgp) # otherwise, one can also use &#39;Obi-warp&#39; method for alignment xdata &lt;- adjustRtime(xdata, param = ObiwarpParam(binSize = 0.6)) ## Grouping with RT corrected peaks pdp &lt;- PeakDensityParam(sampleGroups = xdata$sample_group, minFraction = 0.4, bw = 20) xdata &lt;- groupChromPeaks(xdata, param = pdp) ####峰补齐(filling gaps) 对于峰检测过程中会有部分feature在某些样品中未检出对应代谢物峰的清醒，xcms可以根据已检出feature的信息，在相应样品中强行提取EIC信息，从而计算该代谢物在该样品中的含量信息，我们一般称之为filling gaps xdata &lt;- fillChromPeaks(xdata) 4.3.2 xcms中传统的峰检测方法 require(xcms) ## Get the full path to the data files(mzxml) files &lt;- list.files(&#39;Data&#39;, pattern = &#39;(?i)mzxml$&#39;,full.names = TRUE, recursive = TRUE) xdata &lt;- xcmsSet(files, method = &#39;centWave&#39;, peakwidth = c(5, 50), noise= 1000, snthr = 10) # peak alignment &amp; groups # peakgroups method xdata &lt;- xcms::group(xdata, minfrac = 1) xdata&lt;- retcor(xdata, method = &#39;peakgroups&#39;, plottype = &#39;deviation&#39;) # or obiwarp method xdata&lt;- retcor(xdata, method = &#39;obiwarp&#39;, plottype = &#39;deviation&#39;, profStep = 0.6) xdata&lt;- xcms::group(xdata, bw = 20, minfrac = 1) # fill gaps xdata &lt;-fillPeaks(xdata) ###补充说明 findChromPeaks是xcms中用于进行峰检测的新方法，输入值为’OnDiskMSnExp’对象和峰检测参数对象，CentWaveParam用以创建’CentWaveParam’对象，该对象设置使用’centWave’算法进行峰检测时所需要的参数，其中比较常用的参数如下： - ppm – 峰检测时MS1的m/z tolerance，以ppm为单位 - peakwidth – 长度为2的向量，设置峰检测时峰宽范围，事实上该参数对应的每个峰可以跨越多少个质谱检测的scan，而非多少秒 - snthresh – 峰检测时信噪比要求 - return.type – 返回数据类型，可以根据要求返回’XCMSnExp’类数据（默认）、传统的’xcmsSet’类以及’list’ xcmsSet是xcms中可以用于峰检测的传统方法，使用method参数设置峰检测算法，另外根据不同的峰检测算法可以设置该算法需要的参数，详情请参考xcms官方文档。其中’centWave’算法所对应的参数与’CentWaveParam’设置基本一致。 峰检测时除了可以使用centWave算法外，还可以使用其他算法，如’centWaveWithPredIsoROIs’、‘massifquant’、‘matchedFilter’、‘MSW’等，分别对应’CentWavePredIsoParam’、‘MassifquantParam’、‘MatchedFilterParam’、’MSWParam’参数设置，详情请参考xcms官方文档或者使用R help 4.4 利用CAMERA进行峰注释 借助LC-MS技术检测得到的代谢物峰包含了大量的同位素峰和加合物峰信息，对数据的进一步造成一定干扰，因而做好同位素和加合物峰的注释对代谢组学数据分析具有重要的辅助作用。常见的注释工具有CAMERA和RAMCluster等，在这里主要介绍基于CAMERA的代谢物峰注释基本操作和其中的一些注意事项。 4.4.1 CAMERA包介绍 CAMERA是一个Bioconductor R包，主要用于LC-MS数据中代谢物峰的注释，从而标记峰与峰之间的同位素和加合物关系， 具体原理请参考Carsten Kuhl等人2012年发表于分析化学(Analytical Chemistory)上的文章(Kuhl et al. 2012)。 该R包具体相关信息可以参考Bioconductor网站，关于利用CAMERA进行注释的详细方法和例子可以参考最新文档， 4.4.1.1 注释前的预备工作 峰检测完成后则可以开始CAMERA注释的操作了。在正式注释同位素和加合物峰之前，需要对峰检测数据进行进一步的处理，创建CAMERA注释对象，并进行分组并检验分组结果 require(CAMERA) #Create an xsAnnotate object xa &lt;- xsAnnotate(xdata) #Group after RT value of the xcms grouped peak xag &lt;- groupFWHM(xa, perfwhm=0.6) #Verify grouping xac &lt;- groupCorr(xag) 4.4.1.2 同位素峰注释 #Annotate isotopes, could be done before groupCorr xac.isotope &lt;- findIsotopes(xac) 4.4.1.3 加合物峰注释 在同位素峰注释完成之后，才可以进行加合物峰的注释。 #Annotate adducts xac.addu &lt;- findAdducts(xac.isotope, polarity=&quot;positive&quot;) 在这里需要注意的是，加合物的注释可以自己给定加合物注释的规则(rules)。事实上，CAMERA本身内置了非常多的加合物形式的规则，但对于不同的LC体系，产生的加合物形式会有所不同，因而，对于特定的实验来说，最好根据大家对实验中采用的LC体系的了解，自己制定针对性的注释规则。对于CAMERA中的加合物注释规则，大家可以使用以下代码提取，在自己制定规则的时候，可以用做参考。 # list all rule files (for positive/negative modes, primary/extende rules) files &lt;- list.files(system.file(&#39;rules&#39;, package = &quot;CAMERA&quot;), full.names = TRUE) # show head lines of sample rule head(read.csv(files[4])) ## name nmol charge massdiff oidscore quasi ips ## 1 [M+H]+ 1 1 1.007 1 1 1 ## 2 [M+Na]+ 1 1 22.989 8 1 1 ## 3 [M+K]+ 1 1 38.963 10 1 1 ## 4 [M+NH4]+ 1 1 18.034 16 1 1 对于以上每一列表示的具体含义，可以参考使用文档‘Create rule table’章节（Bioconductor v3.9 在14页，Section 6） 如果需要使用自定义的规则，请参考以下代码： my.rules &lt;- read.csv(files[4]) xac.addu &lt;- findAdducts(xac.isotope, rules = my.rules, polarity=&quot;positive&quot;) 注：polarity请根据自己实验采集数据时的离子模式正确设置，在不设置自定义规则的时候，CAMERA会调用内置的与该离子模式相同的规则（包含primary和extended）进行注释。 4.4.1.4 注释结果表格输出 #Get final peaktable and store on harddrive res.anno &lt;- getPeaklist(xac.addu) write.csv(res.anno,file=&quot;Result.csv&quot;) head(res.anno) 对于adduct列，我们看到的最后部分的数字表示该加合物形式对应的M的质荷比，方括号内显示的是M的加合物形式，方括号后面的‘+’号则表示该加合物形式的电荷数量。而同位素注释结果中最前面的方括号表示该同位素所对应的id，id相同的峰为同一个M峰的不同同位素峰，第二个方括号中的M+x表示同位素峰中的同位素情况，方括号外面的内容则表示电荷情况。pcgroup列则是在预处理时CAMERA生成的group信息 4.4.2 小结 峰检测是质谱数据处理的基础，利用峰检测可以获取样品中检测到的信号的基本信息，如mz、RT、峰面积等，这些信息是代谢物鉴定和差异分析的基础，利用xcms进行峰检测，并借助于CAMERA进行峰注释，可以有效的检测到样品中含有的代谢物信息，并去除部分冗余。除了xcms，还有很多同样优秀的质谱数据处理分析的软件，如OpenMS，MZ Mine2，MS-DIAL等，在此暂不做详细介绍，如有兴趣请参考相应软件的官方说明。 参考文献 "],
["chapMSMS.html", "第 5 章 二级谱图提取 5.1 DDA数据里的二级谱图 5.2 利用ProteoWizard进行二级谱图提取 5.3 利用XCMS进行二级谱图提取 5.4 小结", " 第 5 章 二级谱图提取 5.1 DDA数据里的二级谱图 5.2 利用ProteoWizard进行二级谱图提取 5.2.1 普图提取 5.2.2 与峰检测结果进行结合 5.3 利用XCMS进行二级谱图提取 5.4 小结 "],
["chapID.html", "第 6 章 代谢物鉴定 6.1 代谢物鉴定方法介绍 6.2 常用鉴定工具", " 第 6 章 代谢物鉴定 6.1 代谢物鉴定方法介绍 6.2 常用鉴定工具 "],
["chapSTAT.html", "第 7 章 基本差异分析 7.1 代谢物差异分析简介 7.2 Fold change 7.3 基本统计检验", " 第 7 章 基本差异分析 7.1 代谢物差异分析简介 7.2 Fold change 7.3 基本统计检验 7.3.1 Students’ t-Test 7.3.2 Wilcoxon Test 7.3.3 小结 "],
["chapPCA.html", "第 8 章 主成分分析（PCA） 8.1 PCA原理及简介 8.2 利用R进行PCA分析 8.3 结果解读", " 第 8 章 主成分分析（PCA） 8.1 PCA原理及简介 8.2 利用R进行PCA分析 8.3 结果解读 "],
["chapPLS.html", "第 9 章 PLS-DA和OPLS-DA 9.1 PLS-DA 9.2 OPLS-DA", " 第 9 章 PLS-DA和OPLS-DA 9.1 PLS-DA 9.2 OPLS-DA "],
["sound.html", "A 余音绕梁", " A 余音绕梁 呐，到这里朕的书差不多写完了，但还有几句话要交待，所以开个附录，再啰嗦几句，各位客官稍安勿躁、扶稳坐好。 "],
["references.html", "参考文献", " 参考文献 "]
]
