[
["index.html", "基于非靶向代谢组学的化学成分差异性分析 寄言", " 基于非靶向代谢组学的化学成分差异性分析 Yandong Yin 2019-09-06 寄言 借此为代谢组学贡献绵薄之力 "],
["Intro.html", "第 1 章 简介", " 第 1 章 简介 液相色谱-质谱联用技术（LC-MS）在代谢组学中有着非常广泛的应用，代谢组学借助于LC-MS，可以广泛的筛查样品中存在的代谢物（小分子化合物）及其含量，具有高通量、高灵敏度、动态范围广等特点，可以实现优质的代谢组学分析。根据实验目的，一般我们可以采用靶向代谢组学方法进行特定目标代谢物的高准确度定量分析，如MRM/SRM/PRM等技术，也可以采用非靶向代谢组学筛查样品中包含的代谢物及其差异，从而实现广谱的代谢物筛查，根据质谱中数据采集方式的不同，分为数据依赖型采集（DDA）和数据非依赖型采集（DIA）两类(Figure 1.1)。 Figure 1.1: DDA and DIA MS techniques(Wang, Yin, and Zhu 2019) 其中，DDA技术根据一级质谱扫描时扫描带的离子的强度信息，选择强度较高的部分离子分多次进行碎裂，每次得到于所选择单个目标离子对应的二级谱图，从而实现借助于二级谱图的代谢物鉴定。而DIA技术则是每次选择全部（MSE/AIF）或者部分（SWATH）母离子进行碎裂，理论上可以得到所有母离子的二级信息，然而从数据采集和记录本身无法直接获取每个母离子对应的二级谱图，因而数据分析较为复杂。综合而言，DDA技术作为传统的非靶向LC-MS/MS技术，虽然受限于采集到的二级谱图覆盖范围（一般在30%-60%），但受益于其数据分析的便利性，在代谢组学中有着广泛的应用，而DIA技术，虽然理论上可以获取所有母离子的二级谱图（实际覆盖范围在90%左右），但数据分析较为复杂，数据分析软件仍然有一定的局限性，因而在代谢组学中应用依然较少。 在此，我们主要借助于R和xcms探讨DDA技术的数据分析原理和代谢物鉴定的方法，并介绍常用软件和代谢物鉴定数据库，以及代谢物差异性分析，如有任何错漏或者疑问，欢迎联系本人（ydrick@gmail.com） 参考文献 "],
["basis.html", "第 2 章 R语言及环境配置 2.1 R语言环境安装 2.2 质谱数据分析相关R包安装 2.3 代谢物鉴定软件 2.4 数据转换软件 2.5 数据准备", " 第 2 章 R语言及环境配置 在此，我们主要基于R语言，并利用XCMS等关于代谢组学数据处理R包进行示例说明，以此来 介绍非靶向代谢组学中LC-MS数据特点和数据处理方法，因而首先介绍环境配置。 2.1 R语言环境安装 2.1.1 R语言安装 R语言可于官方网站下载系统需要的版本，一般选择最新 稳定版本。 Windows和MacOS系统请直接下载安装文件。 Linux系统可以使用系统的软件管理程序自动安装或者下载系统对应的二进制文件进行安装 （参见官方介绍，也可以通过下载源码包， 自行编译安装。 Linux通过系统软件管理程序安装代码如下（如果需要安装最新版可能需要安装新的软件 源，具体请搜索查找，在此不再列出）： # Ubuntu sudo apt-get install r-base # CentOS/Fedora/Redhat # (for CentOS/Redhat to add EPEL repositories) sudo yum install epel-release sudo yum install R 2.1.2 Rstudio安装 Rstudio是目前市面上最常用的R IDE，利用Rstudio可以方便的进行R包开发和数据分析， 因而推荐使用Rstudio作为主要IDE， Rstudio可以从官方网站选择 系统对应的版本进行下载，且有免费版本使用，一般免费版本已经足够支持基本的开发和 数据分析了 如果习惯使用VIM、Emacs或者Sublime Text，亦可以找到R相关的插件，以便进行开发和 调试，在此不再赘述。 2.1.3 Rstudio中设置R包安装源 用Rstudio进行R包安装时，默认会使用Rstudio源(https://cran.rstudio.com/)进行安装， 在部分地区和网络下载速度会比较慢，因而可以选择最近的CRAN源进行安装。 选择Tools - Global Options, 在打开的对话框中找到Packages，点击Change进行选择 （Figure 2.1) Figure 2.1: Change CRAN source in Rstudio 2.1.4 Linux/MacOS中安装R缺失库文件 R中有许多R包是调用C/C++开发的，以实现复杂步骤的快速运算，提高运行效率，对这类包 或者部分其他包，在linux或MacOS中进行安装时，会提示无法找到某个lib，这种情况是系 统中缺乏对应依赖的库文件缺失造成的，因而需要安装对应的库文件，然后再安装该R包即可。 具体对于每个提示的缺失的lib，可以搜索对应的Error提示信息和系统信息（如Ubuntu）进行 搜索，即可找到缺失的库文件应该通过安装哪个lib，在此建议使用Google进行搜索，如果 使用百度，请在搜索时使用“R语言”而非“R”。 2.2 质谱数据分析相关R包安装 2.2.1 安装Bioconductor Bioconductor提供了R语言的生物信息软件包，主要用于 生物数据的注释、分析、统计、以及可视化等，最新版本的安装可以参考官方说明 if (!requireNamespace(&quot;BiocManager&quot;, quietly = TRUE)) install.packages(&quot;BiocManager&quot;) BiocManager::install() 新版本的BiocManager包中install方法可以安装Bioconductor中的R包，亦可以安装CRAN中的 R包，因而可以统一使用该方法进行R包安装。 如果是旧版本的R，或者安装旧版本的Biocunductor，请按照一下操作 source(&quot;https://bioconductor.org/biocLite.R&quot;) biocLite(&quot;BiocInstaller&quot;) BiocInstaller::biocLite() 2.2.2 安装XCMS及CAMERA包 library(BiocManager) install(c(&#39;xcms&#39;, &#39;CAMERA&#39;)) 2.2.3 安装需要用到的辅助包 library(BiocManager) install(c(&quot;RColorBrewer&quot;, &quot;faahKO&quot;, &quot;MSnbase&quot;)) 2.3 代谢物鉴定软件 MS-DIAL是Windows下免费的数据处理和代谢物鉴定软件，该软件使用C#编写，因而只支持Windows用户使用。该软件新版本自带MoNA谱图数据库，同时支持自定义谱图库导入，因而对常规质谱数据处理和代谢物鉴定有很大的帮助。 2.4 数据转换软件 目前仪器采集的原始数据，在利用很多厂商提供的软件之外的数据处理软件进行数据处理前需要将之转换为通用数据格式，如mz(X)ML/ABF/netCDF等。xcms和MZmine 2 等支持mz(X)ML，MS-DIAL需要转为ABF。一般，我们可以使用ProteoWizard套件中的msConvert进行数据转换，将数据转换为文本格式，如mzXML，MGF等，如果使用MS-DIAL进行数据处理，则需要使用Reifycs Abf Converter将数据转为Abf(Analysis Base File)格式 2.5 数据准备 在此，进行质谱数据处理的样例数据，放在GitHub的yddream/MSAnalysisRepository的data文件夹里，可以克隆本Repository，直接运行Rmd文件，或者单独下载进行分析。 "],
["chapDDA.html", "第 3 章 DDA-MS技术概要 3.1 DDA技术介绍", " 第 3 章 DDA-MS技术概要 3.1 DDA技术介绍 "],
["chapPD.html", "第 4 章 基于XCMS的峰检测 4.1 LC-MS中峰检测简介 4.2 原始数据转换 4.3 利用XCMS进行峰检测 4.4 利用CAMERA进行峰注释", " 第 4 章 基于XCMS的峰检测 4.1 LC-MS中峰检测简介 在LC-MS中，每一个色谱峰（peak）代表一个代谢物，峰检测(peak detection或peak spotting) 主要目的是检测样品中存在的代谢物，并将多个样品中属于同一个代谢物的色谱峰归类到一起 （称之为峰分组（peak grouping），分组之后的代表多个样品中同一个代谢物峰组称之为一个 feature）。 目前，最常用的峰检测算法是centWave，该算法灵敏度高，可以自动对峰宽在指定范围内利用 小波分析进行判断，从而判定峰的位置和起止点，但该方法在峰的起止点的判定上由于其算法的 局限性，并不能做到非常准确的判断。 峰分组是在单个样品峰检测的基础上，考虑保留时间（RT）漂移等因素，对属于同一个代谢物 的峰进行分组，在峰分组之前需要峰对齐（peak alignment），在xcms中最常用的峰对齐方法 是Obi-Warp，该方法利用采集到的样品数据中的mz，intensity和RT信息进行全局三维对齐， 对齐之后的RT用于峰分组。一般xcms中常用峰密度分布（group.density）方法进行分组。 在LC-MS的峰检测过程中，但样品的峰检测、跨样品的RT校正（峰对齐）和分组是非常重要且 必不可少的过程，缺少任何一步，都会对数据处理质量造成影响，而在某些特定条件下， Obi-Warp方法会失效，因而在数据处理时要注意看xcms反馈的提示信息，并绘制RT漂移的曲线 方便检查数据是否进行了正确的RT校正。 4.2 原始数据转换 MS采集的数据，不同的仪器厂商有不同的数据记录方式，而利用XCMS等数据处理软件进行处理 之前，需要将原始数据转换为通用的软件支持的格式，xcms支持xml、mzData、mzXML、mzML、 netCDF等数据格式，因而在利用xcms进行数据处理之前，需要对于质谱采集的原始数据进行 格式转换，一般可使用ProteoWizard等,具体可以参考GNPS的文档介绍， 在此不再赘述。目前ProteoWizard数据转换支持情况可参见Figure 4.1(GNPS 2019) Figure 4.1: Converting data to MZML/MZXML using ProteoWizard(Wang, Yin, and Zhu 2019) 4.3 利用XCMS进行峰检测 xcms峰检测有两种方法，一种是在xcms3中新近出现的findChromPeaks方法，该方法有很多 新的功能和特性，并方便借用xcms内部的绘图方法，但目前其输出数据格式与其他的常用软件 （如CAMERA）兼容性问题；另一种是传统的xcmsSet方法，由于历史积累和相关软件更新，该 方法目前使用仍较为广泛。以下分别介绍xcms中峰检测的findChromPeaks和xcmsSet方法 4.3.1 xcms3中峰检测的新方法 xcms3的官方文档中有非常详细的数据处理方法的介绍，其中LCMS data preprocessing and analysis with xcms中介绍了如何利用xcms3的新方法进行一级质谱数据处理。 4.3.1.1 数据导入 require(xcms) require(RColorBrewer) ## Get the full path to the data files(mzxml) files &lt;- list.files(&#39;Data&#39;, pattern = &#39;(?i)mzxml$&#39;, full.names = TRUE, recursive = TRUE) ## Create a phenodata data.frame pd &lt;- data.frame(sample_name = sub(basename(files), pattern = &quot;.mzXML&quot;, replacement = &quot;&quot;, fixed = TRUE), sample_group = c(rep(&quot;grp1&quot;, 2), rep(&quot;grp2&quot;, 1)), stringsAsFactors = FALSE) rawData &lt;- readMSData(files = files, pdata = new(&quot;NAnnotatedDataFrame&quot;, pd), mode = &quot;onDisk&quot;) pd ## sample_name sample_group ## 1 DDAdata1 grp1 ## 2 DDAdata2 grp1 ## 3 DDAdata3 grp2 注：readMSData是MSnbase包中读取质谱数据的方法，返回结果为一个属于‘OnDiskMSnExp’ 类的对象。 4.3.1.2 利用centWave算法进行峰检测 # xcms 3 new methods cwp &lt;- CentWaveParam(peakwidth = c(5, 50), noise = 1000, snthresh = 10) xdata &lt;- findChromPeaks(rawData, param = cwp) head(xdata@msFeatureData$chromPeaks) ## mz mzmin mzmax rt rtmin rtmax into intb ## CP0001 702.2 702.2 702.2 45.65 43.14 48.05 8450 8446 ## maxo sn sample ## CP0001 5619 5618 1 ## [ reached getOption(&quot;max.print&quot;) -- omitted 5 rows ] 下图展示检测到的一个峰的示例（Figure @ref(fig:pd_showPeaks)）和在样品中的EIC信息（Figure @ref(fig:pd_showEIC)） ## Define the rt and m/z range of the peak area rtr &lt;- c(375, 400) mzr &lt;- c(132.07604, 132.07639) ## extract the chromatogram chrRaw &lt;- chromatogram(xdata, mz = mzr, rt = rtr) cls &lt;- paste0(brewer.pal(3, &quot;Set1&quot;)[1:2], &quot;60&quot;) names(cls) &lt;- c(&quot;grp1&quot;, &quot;grp2&quot;) plot(chrRaw, col = cls[chrRaw$sample_group], peakBg = cls[chrRaw$sample_group]) Figure 4.2: Extracted ion chromatogram for one peak library(magrittr) # plot EIC/XIC xdata %&gt;% filterRt(rt = rtr) %&gt;% filterMz(mz = mzr) %&gt;% plot(type = &quot;XIC&quot;) Figure 4.3: Visualization of the raw MS data for one peak 4.3.1.3 峰对齐及分组(peak alignment &amp; grouping) 同一代谢物在不同样品的流出时间会略有差异，因而对于峰检测的结果需要进行对齐(alignment)并将不同样品中的统一代谢物分到各自可以表征该代谢物的峰组(peak group)中(代谢组学中一般成为feature)，从而进一步比较不同样品间统一代谢物的含量。通常我们可以使用’obiwarp’算法进行peak alignment，然后利用’density’算法进行peak grouping. ## Correspondence: group peaks across samples. pdp &lt;- PeakDensityParam(sampleGroups = xdata$sample_group, minFraction = 1) xdata &lt;- groupChromPeaks(xdata, param = pdp) ## Now the retention time correction. pgp &lt;- PeakGroupsParam(minFraction = 1) ## Get the peak groups that would be used for alignment. # (grouping with &#39;peakgroup&#39; method) xdata &lt;- adjustRtime(xdata, param = pgp) # otherwise, one can also use &#39;Obi-warp&#39; method for alignment xdata &lt;- adjustRtime(xdata, param = ObiwarpParam(binSize = 0.1)) ## Grouping with RT corrected peaks pdp &lt;- PeakDensityParam(sampleGroups = xdata$sample_group, minFraction = 0.4, bw = 20) xdata &lt;- groupChromPeaks(xdata, param = pdp) ####峰补齐(filling gaps) 对于峰检测过程中会有部分feature在某些样品中未检出对应代谢物峰的清醒，xcms可以根据已检出feature的信息，在相应样品中强行提取EIC信息，从而计算该代谢物在该样品中的含量信息，我们一般称之为filling gaps xdata &lt;- fillChromPeaks(xdata) 4.3.2 xcms中传统的峰检测方法 require(xcms) ## Get the full path to the data files(mzxml) files &lt;- list.files(&#39;Data&#39;, pattern = &#39;(?i)mzxml$&#39;, full.names = TRUE, recursive = TRUE) xdata &lt;- xcmsSet(files, method = &#39;centWave&#39;, peakwidth = c(5, 50), noise= 1000, snthr = 10) # peak alignment &amp; groups # peakgroups method # xdata &lt;- xcms::group(xdata, minfrac = 1) # xdata&lt;- retcor(xdata, method = &#39;peakgroups&#39;, plottype = &#39;deviation&#39;) # or obiwarp method xdata&lt;- retcor(xdata, method = &#39;obiwarp&#39;, plottype = &#39;deviation&#39;, profStep = 0.1) ## center sample: DDAdata3 ## Processing: DDAdata1 DDAdata2 Figure 4.4: RT correction plot xdata&lt;- xcms::group(xdata, bw = 20, minfrac = 1) # fill gaps xdata &lt;-fillPeaks(xdata) # saveRDS(xdata, file = &quot;Data/xset.Rda&quot;) ###补充说明 findChromPeaks是xcms中用于进行峰检测的新方法，输入值为’OnDiskMSnExp’对象和峰检测参数对象，CentWaveParam用以创建’CentWaveParam’对象，该对象设置使用’centWave’算法进行峰检测时所需要的参数，其中比较常用的参数如下： - ppm – 峰检测时MS1的m/z tolerance，以ppm为单位 - peakwidth – 长度为2的向量，设置峰检测时峰宽范围，事实上该参数对应的每个峰可以跨越多少个质谱检测的scan，而非多少秒 - snthresh – 峰检测时信噪比要求 - return.type – 返回数据类型，可以根据要求返回’XCMSnExp’类数据（默认）、传统的’xcmsSet’类以及’list’ xcmsSet是xcms中可以用于峰检测的传统方法，使用method参数设置峰检测算法，另外根据不同的峰检测算法可以设置该算法需要的参数，详情请参考xcms官方文档。其中’centWave’算法所对应的参数与’CentWaveParam’设置基本一致。 峰检测时除了可以使用centWave算法外，还可以使用其他算法，如’centWaveWithPredIsoROIs’、‘massifquant’、‘matchedFilter’、‘MSW’等，分别对应’CentWavePredIsoParam’、‘MassifquantParam’、‘MatchedFilterParam’、’MSWParam’参数设置，详情请参考xcms官方文档或者使用R help 4.4 利用CAMERA进行峰注释 借助LC-MS技术检测得到的代谢物峰包含了大量的同位素峰和加合物峰信息，对数据的进一步造成一定干扰，因而做好同位素和加合物峰的注释对代谢组学数据分析具有重要的辅助作用。常见的注释工具有CAMERA和RAMCluster等，在这里主要介绍基于CAMERA的代谢物峰注释基本操作和其中的一些注意事项。 4.4.1 CAMERA包介绍 CAMERA是一个Bioconductor R包，主要用于LC-MS数据中代谢物峰的注释，从而标记峰与峰之间的同位素和加合物关系， 具体原理请参考Carsten Kuhl等人2012年发表于分析化学(Analytical Chemistory)上的文章(Kuhl et al. 2012)。 该R包具体相关信息可以参考Bioconductor网站，关于利用CAMERA进行注释的详细方法和例子可以参考最新文档， 4.4.1.1 注释前的预备工作 峰检测完成后则可以开始CAMERA注释的操作了。在正式注释同位素和加合物峰之前，需要对峰检测数据进行进一步的处理，创建CAMERA注释对象，并进行分组并检验分组结果 require(CAMERA) #Create an xsAnnotate object xa &lt;- xsAnnotate(xdata) #Group after RT value of the xcms grouped peak xag &lt;- groupFWHM(xa, perfwhm=0.6) ## Start grouping after retention time. ## Created 107 pseudospectra. #Verify grouping xac &lt;- groupCorr(xag) ## Start grouping after correlation. ## Generating EIC&#39;s .. ## ## Calculating peak correlations in 107 Groups... ## % finished: 10 20 30 40 50 60 70 80 90 100 ## ## Calculating graph cross linking in 107 Groups... ## % finished: 10 20 30 40 50 60 70 80 90 100 ## New number of ps-groups: 166 ## xsAnnotate has now 166 groups, instead of 107 4.4.1.2 同位素峰注释 #Annotate isotopes, could be done before groupCorr xac.isotope &lt;- findIsotopes(xac) ## Generating peak matrix! ## Run isotope peak annotation ## % finished: 10 20 30 40 50 60 70 80 90 100 ## Found isotopes: 85 4.4.1.3 加合物峰注释 在同位素峰注释完成之后，才可以进行加合物峰的注释。 #Annotate adducts xac.addu &lt;- CAMERA::findAdducts(xac.isotope, polarity=&quot;positive&quot;) ## Generating peak matrix for peak annotation! ## ## Calculating possible adducts in 166 Groups... ## % finished: 10 20 30 40 50 60 70 80 90 100 在这里需要注意的是，加合物的注释可以自己给定加合物注释的规则(rules)。事实上，CAMERA本身内置了非常多的加合物形式的规则，但对于不同的LC体系，产生的加合物形式会有所不同，因而，对于特定的实验来说，最好根据大家对实验中采用的LC体系的了解，自己制定针对性的注释规则。对于CAMERA中的加合物注释规则，大家可以使用以下代码提取，在自己制定规则的时候，可以用做参考。 # list all rule files (for positive/negative modes, primary/extende rules) files &lt;- list.files(system.file(&#39;rules&#39;, package = &quot;CAMERA&quot;), full.names = TRUE) # show head lines of sample rule head(read.csv(files[4])) ## name nmol charge massdiff oidscore quasi ips ## 1 [M+H]+ 1 1 1.007 1 1 1 ## 2 [M+Na]+ 1 1 22.989 8 1 1 ## [ reached &#39;max&#39; / getOption(&quot;max.print&quot;) -- omitted 2 rows ] 对于以上每一列表示的具体含义，可以参考使用文档‘Create rule table’章节（Bioconductor v3.9 在14页，Section 6） 如果需要使用自定义的规则，请参考以下代码： my.rules &lt;- read.csv(files[4]) xac.addu &lt;- CAMERA::findAdducts(xac.isotope, rules = my.rules, polarity=&quot;positive&quot;) ## Generating peak matrix for peak annotation! ## Found and use user-defined ruleset! ## Calculating possible adducts in 166 Groups... ## % finished: 10 20 30 40 50 60 70 80 90 100 注：polarity请根据自己实验采集数据时的离子模式正确设置，在不设置自定义规则的时候，CAMERA会调用内置的与该离子模式相同的规则（包含primary和extended）进行注释。 4.4.1.4 注释结果表格输出 #Get final peaktable and store on harddrive res.anno &lt;- CAMERA::getPeaklist(xac.addu) saveRDS(res.anno, file = &quot;Data/AnnoRes.Rda&quot;) # write.csv(res.anno,file=&quot;Result.csv&quot;) knitr::include_graphics(&quot;Figures/Fig_CameraResExample.png&quot;) Figure 4.5: Example of CAMERA annotation results Figure 1.1展示了CAMERA注释的结果，对于adduct列，我们看到的最后部分的数字表示该加合物形式对应的M的质荷比，方括号内显示的是M的加合物形式，方括号后面的‘+’号则表示该加合物形式的电荷数量。而同位素注释结果中最前面的方括号表示该同位素所对应的id，id相同的峰为同一个M峰的不同同位素峰，第二个方括号中的M+x表示同位素峰中的同位素情况，方括号外面的内容则表示电荷情况。pcgroup列则是在预处理时CAMERA生成的group信息 4.4.2 小结 峰检测是质谱数据处理的基础，利用峰检测可以获取样品中检测到的信号的基本信息，如mz、RT、峰面积等，这些信息是代谢物鉴定和差异分析的基础，利用xcms进行峰检测，并借助于CAMERA进行峰注释，可以有效的检测到样品中含有的代谢物信息，并去除部分冗余。除了xcms，还有很多同样优秀的质谱数据处理分析的软件，如OpenMS，MZmine 2 ，MS-DIAL等，在此暂不做详细介绍，如有兴趣请参考相应软件的官方说明。 参考文献 "],
["chapMSMS.html", "第 5 章 二级谱图提取 5.1 DDA数据里的二级谱图 5.2 利用ProteoWizard进行二级谱图提取 5.3 利用XCMS进行二级谱图提取 5.4 小结", " 第 5 章 二级谱图提取 5.1 DDA数据里的二级谱图 DDA采集模式在采集二级(MSMS or MS2)谱图时，会按照母离子丰度从高代低依次采集，然后记录采集谱图时目标的母离子的m/z信息和采集时间，但无法记录采集时该MS1离子的强度(intensity)，因而，可以根据记录的母离子m/z和采集时间，与对峰检测中获取的峰进行对应，从而获取代表采集到的代谢物的二级谱图信息，进而通过谱图比对的方式进行代谢物鉴定，同时利用峰检测结果进行定量。甚至可以只用二级谱图的信息，直接通过谱图比对，进行代谢物鉴定。 要获取二级谱图信息，最简单的方法是利用ProteoWizard中的msConvert直接进行数据转换，只提取MS2信息生成MGF格式数据，再读取MGF文本信息，从而在程序里获得MS2数据，进行后续处理；另一种方法是直接在xcms中直接读取转换好的mzXML文件，并从中得到二级谱图信息，或者根据一级峰检测结果，从二级质谱数据中提取与之对应的谱图数据。 5.2 利用ProteoWizard进行二级谱图提取 MSConvert转换数据到MGF时，设置如Figure 5.1所示。转换完之后，即可得到对应的MGF文件(Figure 5.2) Figure 5.1: Converting mzXML to MGF with msConvert Figure 5.2: Example of MGF data record 5.2.1 谱图提取 利用R读取MGF文件，并获取MS2谱图信息。 source(&quot;Code/ReadMGF.R&quot;) files &lt;- list.files(path = &quot;Data&quot;, pattern = &quot;(?i).MGF$&quot;, recursive = TRUE, full.names = TRUE) mgf.data &lt;- ReadMGF(files[1]) spec.info &lt;- plyr::ldply(mgf.data, `[[`, &quot;info&quot;) head(spec.info) ## mz rt ## 1 188.2 5.293 ## 2 237.2 5.343 ## 3 247.2 5.393 ## 4 309.0 5.443 ## 5 340.1 5.493 ## 6 367.1 5.543 spec.all &lt;- lapply(mgf.data, `[[`, &quot;spec&quot;) plot(spec.all[[2682]], type = &quot;h&quot;, col = &quot;red&quot;) abline(h=0) Figure 5.3: Example of extracted MS2 spectrum 对谱图信息进行去噪音处理 仪器记录的原始MS2谱图信息含有很多噪音(white noise)，不同的仪器有不同的噪音水平，可以根据记录的强度信息大致做出评判，一般在我们使用的这组数据中，采用30作为噪音的基准值(Figure 5.4)，对于低于该水平的二级碎片，要清除掉。另外，在记录的MS2谱图里面，也会包含有高于母离子m/z的碎片出现，这些碎片也要清除掉(Figure 5.5)。 frag.all &lt;- do.call(rbind, spec.all) plot(density(frag.all[frag.all[, 2] &lt;= 200, 2]), main = &quot;Density of intensities (&lt;=200)&quot;) Figure 5.4: Density of MS2 spectra intensities spec.denoise &lt;- lapply(seq_along(spec.all), function(idx) { spec &lt;- spec.all[[idx]] spec &lt;- spec[spec[, 2] &gt;= 30, , drop = FALSE] mz.precursor &lt;- spec.info[idx, &quot;mz&quot;] spec &lt;- spec[spec[, 1] &lt;= mz.precursor, , drop = FALSE] }) plot(spec.all[[2682]], type = &quot;h&quot;, col = &quot;gray50&quot;) lines(spec.denoise[[2682]], type = &quot;h&quot;, col = &quot;red&quot;) abline(h=0) abline(h=30, lty = 3) abline(v=spec.info[2682, &quot;mz&quot;], lty = 3, col = &quot;green4&quot;) Figure 5.5: Example of extracted MS2 spectrum 5.2.2 与峰检测结果进行结合 根据提取出来的MS2谱图的m/z和rt信息，与之前得到的峰检测结果进行匹配，将匹配上的，保留为与检测到的峰对应的MS2谱图。对同一个代谢物，有可能打到多张MS2谱图，此时，要选择其中某一张谱图最为标准或者用合适的方法合并这两张谱图，从而得到在样品中采集到的二级谱图信息 pk.info &lt;- readRDS(&quot;Data/AnnoRes.Rda&quot;) mz.pk &lt;- pk.info[, &quot;mz&quot;] mz.spec &lt;- spec.info[, &quot;mz&quot;] rt.spec &lt;- spec.info[, &quot;rt&quot;] idx.spec &lt;- apply(pk.info, 1, function(dr) { mz &lt;- as.numeric(dr[&quot;mz&quot;]) rt &lt;- as.numeric(dr[&quot;rt&quot;]) idx &lt;- which(mz.spec &gt;= mz - 0.01 &amp; mz.spec &lt;= mz + 0.01 &amp; rt.spec &gt;= rt - 5 &amp; rt.spec &lt;= rt + 5) }) require(xcms) xset &lt;- readRDS(&quot;Data/xset.Rda&quot;) eic &lt;- getEIC(xset, groupidx = 7, rtrange = 50, sampleidx=sampnames(xset)[1], rt = &quot;raw&quot;) par(mfrow=c(1,2)) plot(eic@eic$DDAdata1[[1]], type = &quot;b&quot;, col = &quot;red&quot;) # points(eic@eic$DDAdata1[[1]], col = &quot;gray&quot;) abline(v=rt.spec[idx.spec[[7]]], col = &quot;green4&quot;, lty = 2) plot(spec.denoise[[idx.spec[[7]][2]]], type = &quot;h&quot;, col = &quot;red&quot;, ylim = c(0, 200)) abline(h=0) Figure 5.6: Example of matched spectrum to MS1 peak 5.3 利用XCMS进行二级谱图提取 5.4 小结 "],
["chapID.html", "第 6 章 代谢物鉴定 6.1 代谢物鉴定方法介绍 6.2 常用鉴定工具 6.3 自行进行代谢物鉴定", " 第 6 章 代谢物鉴定 代谢组学最重要的目标之一，就是获取样品中有哪些代谢物，并知道该代谢物的含量信息。因而代谢物的鉴定，成为在峰检测之后最为重要的工作，只有在获取准确的代谢物鉴定结果的基础上，才可以准确的做接下来的生物信息学的各项分析。 6.1 代谢物鉴定方法介绍 通过与标准谱图库里的MS2谱图进行比对，从而获取采集到的代谢物的信息是最常用且有效的方法，对于少量的数据，可以用在线的代谢物鉴定工具进行处理即可，如METLIN，MassBank，MoNA等。另外也可以通过理论谱图进行鉴定，如CFM-ID，MetFrag等。 对于植物代谢物，GNPS谱图库（GNPS Public Spectral Libraries）含有大量的自然产物信息，GNPS网站支持批量通过谱图比对进行代谢物鉴定，也是非常不错的代谢物鉴定工具。除此之外，GNPS包含了很多植物代谢组学和自然产物相关的数据处理分析的工具，如有兴趣，可以自行去官方网站了解学习，在此不多赘述。 特别要注意的是，在代谢物鉴定的时候，一定要选择与自己数据采集时相对应的仪器平台的标准谱图进行比较。这是因为，在LC-MS中采集到的MS2谱图，不同的仪器平台会有很大的差异，Q-TOF和Obitrap的谱图在大多数情况下显著不同，同时，即便同一平台，不同仪器之间的谱图也会略有差异，但仍可用于代谢物鉴定，只是对鉴定的可信度略有影响。而在MassBank/MoNA谱图库中，包含了来自所有仪器平台的谱图信息，因而，在利用该谱图库进行代谢物鉴定时一定要非常注意。另外，METLIN数据库很多时候会屏蔽部分IP地址，因而国内很多地方可能无法使用，对我们会造成不便，目前美国的IP地址基本可以访问。 6.2 常用鉴定工具 6.2.1 利用MS-DIAL进行DDA数据处理并进行代谢物鉴定 MS-DIAL软件的官方文档有较详细的说明， 6.3 自行进行代谢物鉴定 由于很多代谢物谱图库包含了大量冗余信息，包含很多与自己数据采集时仪器平台不一致的代谢物谱图，同时对鉴定结果不易批量处理，因而，自行进行代谢物鉴定也是非常不错的途径，且可以自行定制代谢物鉴定的比对方法，考虑更多的因素到代谢物鉴定当中来，通过脚本进行自动化代谢物鉴定也是非常常见的方式。 对于利用谱图比对的方式进行代谢物鉴定，首先需要有谱图相似度的比对方法，并对相似度作出正确评判，目前最常用的相似度判断方法为点积(Dot Product)，可以根据不同的目的和谱图库特性选择是正向(Forward)还是反向(Reverse)匹配进行计算。一般对于利用标准品采集获取标准谱图库，我们认为标准谱图库是精准的，可以严格作为判定标准，因而将标准谱图库做正向匹配，获得Forward Dot Product，从而进行代谢物鉴定。 "],
["chapSTAT.html", "第 7 章 基本差异分析 7.1 代谢物差异分析简介 7.2 Fold change 7.3 基本统计检验", " 第 7 章 基本差异分析 7.1 代谢物差异分析简介 7.2 Fold change 7.3 基本统计检验 7.3.1 Students’ t-Test 7.3.2 Wilcoxon Test 7.3.3 小结 "],
["chapPCA.html", "第 8 章 主成分分析（PCA） 8.1 PCA原理及简介 8.2 利用R进行PCA分析 8.3 结果解读", " 第 8 章 主成分分析（PCA） 8.1 PCA原理及简介 8.2 利用R进行PCA分析 8.3 结果解读 "],
["chapPLS.html", "第 9 章 PLS-DA和OPLS-DA 9.1 PLS-DA 9.2 OPLS-DA", " 第 9 章 PLS-DA和OPLS-DA 9.1 PLS-DA 9.2 OPLS-DA "],
["sound.html", "A 余音绕梁", " A 余音绕梁 呐，到这里朕的书差不多写完了，但还有几句话要交待，所以开个附录，再啰嗦几句，各位客官稍安勿躁、扶稳坐好。 "],
["references.html", "参考文献", " 参考文献 "]
]
